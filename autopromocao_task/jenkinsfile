pipeline {
    agent any

    parameters {
        string(name: 'Email', defaultValue: 'suporte.admin@sysvision.global', description: 'Email do TAC')
        string(name: 'Senha', defaultValue: 'Sys@lo321', description: 'Senha do TAC')
        string(name: 'taskId', defaultValue: '', description: 'Id da Task')
        // Adicione outros parâmetros conforme necessário
    }

    environment {
        SUCCESS_COUNT = 0  // Contador de sucessos
    }

    stages {
        stage('Acessar Servidor e Verificar Status') {
            steps {
                script {
                    // Executa o comando e captura a saída
                    def output = sh(script: """ 
                        sshpass -p 'Sys@lo321' ssh -o StrictHostKeyChecking=no sysvision@10.150.71.101 '
                        cd /opt/Talend-8.0.1/tac/apache-tomcat/webapps/org.talend.administrator/WEB-INF/classes/ &&
                        ./MetaServletCaller.sh --tac-url=http://10.150.71.101:8080/org.talend.administrator --json-params="
                        { 
                            \\"actionName\\": \\"getTaskStatus\\",
                            \\"authPass\\": \\"${Senha}\\",
                            \\"authUser\\": \\"${Email}\\",
                            \\"taskId\\": \\"${taskId}\\"
                        }"'""", returnStdout: true).trim()

                    // Captura o NO_ERROR da saída
                    def statusMatch = output =~ /"NO_ERROR"/
                    if (statusMatch) {
                        SUCCESS_COUNT = SUCCESS_COUNT.toInteger() + 1
                        echo "Sucesso! Contador: ${SUCCESS_COUNT}"
                    } else {
                        SUCCESS_COUNT = 0
                        echo "Erro encontrado. Contador resetado."
                    }

                    // Grava o contador de sucesso em um arquivo
                    writeFile file: 'success_count.txt', text: "${SUCCESS_COUNT}"
                }
            }
        }
    }

    post {
        success {
            script {
                // Se atingiu 3 sucessos, dispara a pipeline de produção
                def successCount = readFile('success_count.txt').toInteger()
                if (successCount >= 3) {
                    build job: 'criação_Job_Talend'  // Nome da outra pipeline que promove para produção
                }
            }
        }
    }
}
