pipeline {
    agent any

    parameters {
        string(name: 'Email', defaultValue: 'suporte.admin@sysvision.global', description: 'Email do TAC')
        string(name: 'Senha', defaultValue: 'Sys@lo321', description: 'Senha do TAC')
        string(name: 'taskId', defaultValue: '', description: 'Id da Task')
        // Adicione outros parâmetros conforme necessário
    }

    environment {
        env.SUCCESS_COUNT = 0  // Contador de sucessos
    }

    stages {
        stage('Acessar Servidor e Verificar Status') {
            steps {
                script {
                    // Executa o comando e captura a saída
                    def output = sh(script: """ 
                        sshpass -p 'Sys@lo321' ssh -o StrictHostKeyChecking=no sysvision@10.150.71.101 '
                        cd /opt/Talend-8.0.1/tac/apache-tomcat/webapps/org.talend.administrator/WEB-INF/classes/ &&
                        ./MetaServletCaller.sh --tac-url=http://10.150.71.101:8080/org.talend.administrator --json-params="
                        { 
                            \\"actionName\\": \\"getTaskStatus\\",
                            \\"authPass\\": \\"${Senha}\\",
                            \\"authUser\\": \\"${Email}\\",
                            \\"taskId\\": \\"${taskId}\\"
                        }"'""", returnStdout: true).trim()

                    // Captura o NO_ERROR da saída
                    def statusMatch = output =~ /"NO_ERROR"/
                    if (statusMatch) {
                        env.SUCCESS_COUNT = env.SUCCESS_COUNT.toInteger() + 1
                        echo "Sucesso! Contador: ${env.SUCCESS_COUNT}"
                    } else {
                        env.SUCCESS_COUNT = 0
                        echo "Erro encontrado. Contador resetado."
                    }

                    // Grava o contador de sucesso em um arquivo
                    writeFile file: 'success_count.txt', text: "${SUCCESS_COUNT}"
                }
            }
        }
    }

     post {
        always {
            script {
                // Exibe o valor da variável SUCCESS_COUNT ao final
                echo "Valor final do SUCCESS_COUNT: ${env.SUCCESS_COUNT}"
                }
            }
        }
    }
